# 初期管理者ユーザー設定方法

## 概要
SFAシステムでカスタムフィールドの追加やユーザー権限管理を行うには、管理者権限が必要です。
開発環境と本番環境で、初期管理者ユーザーを設定する方法を説明します。

## 方法1: APIエンドポイントを使用（開発環境のみ・推奨）

### 開発環境用の初期管理者ユーザーを設定

開発環境では、以下のAPIエンドポイントを使用して開発ユーザーを管理者に設定できます。

```bash
# ターミナルから実行
curl -X POST http://localhost:3000/api/users/setup-dev \
  -H "Content-Type: application/json" \
  -d '{"email": "tmatsukuma@redish.jp", "role": "admin"}'
```

または、ブラウザのコンソールから実行：

```javascript
fetch('/api/users/setup-dev', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email: 'tmatsukuma@redish.jp', role: 'admin' })
})
.then(res => res.json())
.then(data => console.log(data));
```

**注意**: このエンドポイントは開発環境（`NODE_ENV=development`）でのみ動作します。

## 方法2: マイグレーションを使用

### 既存ユーザーを管理者にする

```bash
# マイグレーションファイルを実行
# Supabase CLIを使用する場合
supabase migration up

# または、SupabaseダッシュボードのSQLエディタで実行
```

マイグレーションファイル: `supabase/migrations/007_seed_development_admin.sql`

このマイグレーションは、最初に作成されたユーザーを管理者に設定します。

## 方法2: Supabaseダッシュボードから直接設定

### 手順

1. **Supabaseダッシュボードにログイン**
   - https://supabase.com/dashboard にアクセス
   - プロジェクトを選択

2. **SQLエディタを開く**
   - 左メニューから「SQL Editor」を選択

3. **以下のSQLを実行**

```sql
-- 既存のユーザーを管理者にする場合
UPDATE users 
SET role = 'admin'
WHERE email = 'tmatsukuma@redish.jp';

-- または、新しい管理者ユーザーを作成する場合
-- 注意: idはauth.usersテーブルの実際のユーザーIDを使用してください
INSERT INTO users (id, email, full_name, role, department)
VALUES (
  '実際のauth.users.idをここに記入',
  'your-email@example.com',
  '管理者名',
  'admin',
  '部署名'
)
ON CONFLICT (email) 
DO UPDATE SET role = 'admin';
```

4. **auth.usersテーブルからユーザーIDを取得**
   - 左メニューから「Authentication」→「Users」を選択
   - 対象ユーザーのUUIDをコピー
   - 上記のSQLの`実際のauth.users.idをここに記入`部分に貼り付け

## 方法3: 既存ユーザーの最初の1人を管理者にする

```sql
-- 最初に作成されたユーザーを管理者にする
UPDATE users 
SET role = 'admin'
WHERE id = (SELECT id FROM users ORDER BY created_at ASC LIMIT 1)
AND role != 'admin';
```

## 確認方法

1. **アプリケーションにログイン**
   - 設定画面を開く
   - 「ユーザー権限」タブを選択
   - 「現在のユーザー情報」セクションで権限を確認
   - 「管理者」と表示されていれば成功

2. **カスタムフィールド追加ボタンの確認**
   - 「シート連携」タブ → 「連携カラム」サブタブ
   - 「カスタムマッピングフィールド」セクションの右上に「+ カスタムフィールドを追加」ボタンが表示されていれば成功

## トラブルシューティング

### 問題: 「ログイン情報を取得できませんでした」と表示される

**原因**: 
- セッション情報が正しく取得できていない
- usersテーブルにユーザー情報が登録されていない

**解決方法**:
1. ブラウザをリロード
2. ログアウトして再度ログイン
3. usersテーブルにユーザー情報が存在するか確認

### 問題: 権限が「権限未設定」と表示される

**原因**: 
- usersテーブルにユーザー情報が存在しない
- メールアドレスが一致していない

**解決方法**:
1. Supabaseダッシュボードでusersテーブルを確認
2. メールアドレスが一致しているか確認
3. 上記の方法でユーザーを登録または更新

### 問題: 開発環境で認証がスキップされている

**原因**: 
- `NODE_ENV=development`の場合、認証ガードがダミーセッションを返す

**解決方法**:
- 開発環境でも実際のSupabase Authを使用する場合は、環境変数を確認
- または、usersテーブルに直接開発ユーザーを登録（方法2を参照）

## 注意事項

- 本番環境では、必ずSupabase Authを使用してください
- 管理者権限は慎重に付与してください
- 開発環境用のダミーUUIDは本番環境では使用しないでください
