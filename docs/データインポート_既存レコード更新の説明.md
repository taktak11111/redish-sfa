# データインポートにおける「既存レコード更新」の説明

## 概要

データインポート処理では、スプレッドシートから取得したデータをデータベースに保存する際、以下の2つのパターンがあります：

1. **新規レコード作成**: データベースに存在しない新しいデータを追加
2. **既存レコード更新**: データベースに既に存在するデータを更新

## 「既存レコード更新」とは

### 判定方法

- `lead_id` が一致する場合は **既存レコードを更新**
- 電話番号（`phone`）が一致する場合は **更新せず新規作成** し、重複フラグを付与

### 処理フロー

```
1. スプレッドシートからデータを取得
2. `lead_id` が一致するレコードを検索
3. 一致があれば更新（UPDATE）
4. 一致がなければ電話番号で重複チェック
5. 電話番号が一致する場合は **新規作成（INSERT）+ 重複フラグ付与**
6. 一致がなければ新規作成（INSERT）
```

### 具体例

**ケース1: 新規レコード作成**
- スプレッドシート: 電話番号「090-1234-5678」のレコード
- データベース: 該当する電話番号のレコードなし
- 結果: 新規レコードとして追加

**ケース2: `lead_id` が一致する既存レコード更新**
- スプレッドシート: 電話番号「090-1234-5678」のレコード（会社名が変更されている）
- データベース: 同じ `lead_id` のレコードが既に存在
- 結果: 既存レコードの会社名を更新

**ケース3: 電話番号が重複する場合**
- スプレッドシート: 電話番号「090-1234-5678」の別レコード
- データベース: 同じ電話番号のレコードが既に存在
- 結果: 新規レコードとして追加し、重複フラグを付与

## 全件取得 vs 差分取得

### 全件取得（`updateMode: 'full'`）

- **動作**: スプレッドシートの全データを処理
- **用途**: 初回インポート、または全データを再同期したい場合
- **処理件数**: スプレッドシートの全行数（空行を除く）

### 差分取得（`updateMode: 'incremental'`）

- **動作**: 最新N件（デフォルト: 100件）のみを処理
- **用途**: 日常的な更新処理（最新データのみを取得）
- **処理件数**: 最新N件（日付でソートして最新のもの）

## 注意事項

### 既存レコード更新時の欠損データ統計

- **新規レコード作成時**: 欠損データ統計をカウント
- **既存レコード更新時**: 欠損データ統計をカウントしない

理由: 既存レコードは過去に既にインポート済みのため、欠損データ統計に含めない

### 成功件数のカウント

- **新規作成件数（`newRecords`）**: 新規に追加されたレコード数
- **更新件数（`updatedRecords`）**: 既存レコードを更新した件数
- **総成功件数（`imported`）**: 新規作成 + 更新の合計

UIでは、新規作成件数を優先的に表示します（新規作成が0件の場合は更新件数を表示）。
