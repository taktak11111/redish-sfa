# パフォーマンス改善提案：読み込み・レスポンス速度

**作成日**: 2026-01-13  
**対象**: 読み込みスピード・レスポンススピードの改善

---

## 現状の問題点

### 🔴 重大なパフォーマンス問題

#### 1. 1秒ごとの`handleStorageChange`呼び出し（最優先）

**問題**:
- 複数のDetailPanelコンポーネント（`DealDetailPanel`, `CallDetailPanel`, `LeadDetailPanel`など）で、**1秒ごとに`getDropdownOptions()`を呼び出してstateを更新**している
- これにより、**不要な再レンダリングが1秒ごとに発生**している

**影響範囲**:
- `DealDetailPanel.tsx`: 1秒ごとに17個の設定を再取得
- `CallDetailPanel.tsx`: 1秒ごとに23個の設定を再取得
- `LeadDetailPanel.tsx`: 1秒ごとに1個の設定を再取得
- `CallListCreateModal.tsx`: 1秒ごとに1個の設定を再取得
- `CallHistoryModal.tsx`: 1秒ごとに1個の設定を再取得

**影響**:
- CPU使用率の増加
- 不要な再レンダリングによるUIの遅延
- メモリ使用量の増加

**現在の実装例**:
```typescript
useEffect(() => {
  const handleStorageChange = () => {
    setDropdownSettings({
      staffIS: getDropdownOptions('staffIS'),
      // ... 17個の設定を再取得
    })
  }
  window.addEventListener('storage', handleStorageChange)
  const interval = setInterval(handleStorageChange, 1000) // ⚠️ 1秒ごと
  return () => {
    window.removeEventListener('storage', handleStorageChange)
    clearInterval(interval)
  }
}, [])
```

---

#### 2. 重複したDB同期処理

**問題**:
- 各ページ/コンポーネントで個別に`refreshDropdownSettingsFromDB()`を呼び出している
- 同じAPIリクエスト（`/api/dropdown-settings`）が複数回発生する可能性がある

**影響範囲**:
- `calls/page.tsx`: DB同期 + `CallDetailPanel.tsx`: DB同期（重複）
- `deals/page.tsx`: DB同期 + `DealDetailPanel.tsx`: DB同期（重複）
- `LeadDetailPanel.tsx`: DB同期
- `ContractDetailPanel.tsx`: DB同期

**影響**:
- 初回読み込み時のネットワークリクエスト数の増加
- サーバー負荷の増加
- 読み込み時間の増加

---

#### 3. 不要なstate更新による再レンダリング

**問題**:
- `handleStorageChange`で`setDropdownSettings()`を呼び出す際、内容が同じでもstateが更新される
- 一部のコンポーネント（`calls/page.tsx`, `deals/page.tsx`）では比較処理があるが、DetailPanelにはない

**影響**:
- 不要な再レンダリングの発生
- 子コンポーネントの再レンダリング

---

## 改善提案

### 🔴 優先度1: 即座に対応（重大な影響）

#### 1.1 `handleStorageChange`の呼び出し頻度を削減

**現状**: 1秒ごとに呼び出し  
**改善**: 30秒ごとに呼び出し（`calls/page.tsx`, `deals/page.tsx`と同じ頻度）

**修正対象**:
- `DealDetailPanel.tsx`: `setInterval(handleStorageChange, 1000)` → `setInterval(handleStorageChange, 30000)`
- `CallDetailPanel.tsx`: `setInterval(handleStorageChange, 1000)` → `setInterval(handleStorageChange, 30000)`
- `LeadDetailPanel.tsx`: `setInterval(handleStorageChange, 1000)` → `setInterval(handleStorageChange, 30000)`
- `CallListCreateModal.tsx`: `setInterval(handleStorageChange, 1000)` → `setInterval(handleStorageChange, 30000)`
- `CallHistoryModal.tsx`: `setInterval(handleStorageChange, 1000)` → `setInterval(handleStorageChange, 30000)`

**効果**:
- 呼び出し頻度を**30分の1に削減**（1秒 → 30秒）
- CPU使用率の大幅な削減
- 不要な再レンダリングの削減

**注意事項**:
- `storage`イベントリスナーは維持（設定メニューでの変更を即座に反映）
- インターバルは補完的な役割（設定メニューを開いていない場合の更新）

---

#### 1.2 重複したstate更新の防止

**現状**: 内容が同じでもstateを更新  
**改善**: 内容が同じ場合はstateを更新しない

**修正対象**:
- `DealDetailPanel.tsx`: `handleStorageChange`内で比較処理を追加
- `CallDetailPanel.tsx`: `handleStorageChange`内で比較処理を追加
- `LeadDetailPanel.tsx`: `handleStorageChange`内で比較処理を追加

**実装例**:
```typescript
useEffect(() => {
  const handleStorageChange = () => {
    const newSettings = {
      staffIS: getDropdownOptions('staffIS'),
      // ... 他の設定
    }
    // 内容が同じなら更新しない（無限ループ防止）
    setDropdownSettings((prev) => {
      const prevStr = JSON.stringify(prev)
      const newStr = JSON.stringify(newSettings)
      if (prevStr === newStr) return prev
      return newSettings
    })
  }
  // ...
}, [])
```

**効果**:
- 不要な再レンダリングの削減
- CPU使用率の削減

---

#### 1.3 DB同期処理の最適化

**現状**: 各コンポーネントで個別にDB同期  
**改善**: 親コンポーネント（`page.tsx`）でDB同期を実行し、子コンポーネント（`DetailPanel.tsx`）では実行しない

**修正対象**:
- `DealDetailPanel.tsx`: DB同期処理を削除（`deals/page.tsx`で実行済み）
- `CallDetailPanel.tsx`: DB同期処理を削除（`calls/page.tsx`で実行済み）

**注意事項**:
- `LeadDetailPanel.tsx`と`ContractDetailPanel.tsx`は親コンポーネントがないため、DB同期を維持
- ただし、`leads/page.tsx`や`contracts/page.tsx`でDB同期を実装する場合は、DetailPanelから削除

**効果**:
- 重複したAPIリクエストの削減
- 初回読み込み時間の短縮

---

### 🟡 優先度2: 要確認・調整（中程度の影響）

#### 2.1 `storage`イベントリスナーの最適化

**現状**: 各コンポーネントで個別に`storage`イベントリスナーを登録  
**改善**: グローバルな`storage`イベントリスナーを1つだけ登録し、各コンポーネントに通知

**効果**:
- イベントリスナーの数の削減
- メモリ使用量の削減

**注意事項**:
- 実装が複雑になる可能性がある
- 既存の動作を維持する必要がある

---

#### 2.2 `getDropdownOptions()`の結果をメモ化

**現状**: 毎回`getDropdownOptions()`を呼び出してlocalStorageから取得  
**改善**: `useMemo`を使用して結果をメモ化

**効果**:
- 不要なlocalStorageアクセスの削減
- CPU使用率の削減

**注意事項**:
- `storage`イベントが発生した際にメモを無効化する必要がある

---

### ⚠️ 優先度3: 将来対応（軽微な影響）

#### 3.1 React Queryを使用した設定のキャッシュ管理

**現状**: localStorageと手動のDB同期  
**改善**: React Queryを使用して設定をキャッシュ管理

**効果**:
- 自動的なキャッシュ管理
- 重複したリクエストの自動削減
- バックグラウンドでの更新

**注意事項**:
- 既存の実装を大幅に変更する必要がある
- テストが必要

---

## 推奨実装順序

### Phase 1: 即座に対応（優先度1）

1. **`handleStorageChange`の呼び出し頻度を30秒に変更**
   - 修正対象: `DealDetailPanel.tsx`, `CallDetailPanel.tsx`, `LeadDetailPanel.tsx`, `CallListCreateModal.tsx`, `CallHistoryModal.tsx`
   - 効果: 呼び出し頻度を30分の1に削減

2. **重複したstate更新の防止**
   - 修正対象: `DealDetailPanel.tsx`, `CallDetailPanel.tsx`, `LeadDetailPanel.tsx`
   - 効果: 不要な再レンダリングの削減

3. **DB同期処理の最適化**
   - 修正対象: `DealDetailPanel.tsx`, `CallDetailPanel.tsx`
   - 効果: 重複したAPIリクエストの削減

### Phase 2: 要確認・調整（優先度2）

1. `storage`イベントリスナーの最適化
2. `getDropdownOptions()`の結果をメモ化

### Phase 3: 将来対応（優先度3）

1. React Queryを使用した設定のキャッシュ管理

---

## 期待される効果

### Phase 1実装後の効果

- **CPU使用率**: 約30分の1に削減（1秒ごと → 30秒ごと）
- **不要な再レンダリング**: 大幅に削減
- **初回読み込み時間**: 約20-30%短縮（重複したAPIリクエストの削減）
- **メモリ使用量**: 若干の削減

### 測定方法

1. **Chrome DevToolsのPerformanceタブ**でCPU使用率を測定
2. **React DevToolsのProfiler**で再レンダリング回数を測定
3. **Networkタブ**でAPIリクエスト数を確認

---

## 注意事項

1. **既存の動作を維持**: `storage`イベントリスナーは維持し、設定メニューでの変更を即座に反映
2. **段階的実装**: Phase 1から順に実装し、各段階で動作確認
3. **テスト**: 各修正後に動作確認を実施

---

**作成者**: AI開発CTO  
**承認待ち**: 改善策の確認後、実装を開始
