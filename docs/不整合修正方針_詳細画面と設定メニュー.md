# 不整合修正方針：詳細画面と設定メニュー

**作成日**: 2026-01-13  
**対象**: 架電管理、商談管理、成約・契約管理の詳細画面と設定メニューの不整合修正

---

## 修正方針の基本原則

1. **詳細画面の選択肢を優先**: 実際に使用されている詳細画面の選択肢を基準に、設定メニューを更新する
2. **一元管理の徹底**: ハードコードされている選択肢は、可能な限り設定メニューで管理する
3. **後方互換性の維持**: 既存データとの互換性を考慮し、値のマッピングを適切に行う
4. **段階的実装**: 優先度1（重大な不整合）から順に対応

---

## 修正内容の詳細

### 🔴 優先度1: 重大な不整合の修正

#### 1.1 ニーズ温度（IS判定）の追加

**現状**:
- 架電管理・商談管理の両方でハードコードされている
- 選択肢: `A: 期限あり・困り大`, `B: 条件次第・検討`, `C: 情報収集・低温`

**修正内容**:
1. **`dropdownSettings.ts`に新規項目を追加**:
   ```typescript
   needTemperature: DropdownOption[]
   ```
   - `DEFAULT_SETTINGS`に初期値を追加:
     ```typescript
     needTemperature: [
       { value: 'A', label: 'A: 期限あり・困り大' },
       { value: 'B', label: 'B: 条件次第・検討' },
       { value: 'C', label: 'C: 情報収集・低温' },
     ]
     ```

2. **設定メニュー（`settings/page.tsx`）に項目を追加**:
   - 架電管理セクションに追加:
     ```typescript
     { key: 'needTemperature', label: 'ニーズ温度（IS判定）' }
     ```

3. **詳細画面のハードコードを削除**:
   - `CallDetailPanel.tsx`: `getDropdownOptions('needTemperature')`を使用
   - `DealDetailPanel.tsx`: `getDropdownOptions('needTemperature')`を使用

**影響範囲**:
- `CallDetailPanel.tsx`: ニーズ温度（IS判定）の選択肢を設定メニューから取得
- `DealDetailPanel.tsx`: N:ニーズ温度の選択肢を設定メニューから取得
- `dropdownSettings.ts`: 新規項目追加
- `settings/page.tsx`: 設定メニューに項目追加

---

#### 1.2 商談実施状況の統一

**現状**:
- 設定メニュー: `商談キャンセル`, `ノーショー（連絡なし）`, `商談実施`, `商談再設定`
- 詳細画面: `実施前`, `実施済`, `ノーショー 連絡なし`, `キャンセル`, `リスケ`

**修正方針**: **詳細画面の選択肢を優先**（実際に使用されているため）

**修正内容**:
1. **`dropdownSettings.ts`の`meetingStatus`を更新**:
   ```typescript
   meetingStatus: [
     { value: '実施前', label: '実施前' },
     { value: '実施済', label: '実施済' },
     { value: 'ノーショー 連絡なし', label: 'ノーショー 連絡なし' },
     { value: 'キャンセル', label: 'キャンセル' },
     { value: 'リスケ', label: 'リスケ' },
   ]
   ```

2. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `dealExecutionStatus`の選択肢を`getDropdownOptions('meetingStatus')`から取得

**影響範囲**:
- `dropdownSettings.ts`: `meetingStatus`の選択肢を更新
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

**注意事項**:
- 既存データで`商談キャンセル`, `商談実施`, `商談再設定`が使用されている場合、マイグレーションが必要（後述）

---

#### 1.3 商談最終結果の統一

**現状**:
- 設定メニュー: `成約`, `検討中`, `失注`
- 詳細画面: `成約（即決）`, `成約`, `失注`

**修正方針**: **詳細画面の選択肢を優先**（`成約（即決）`が実際に使用されているため）

**修正内容**:
1. **`dropdownSettings.ts`の`dealResult`を更新**:
   ```typescript
   dealResult: [
     { value: '成約（即決）', label: '成約（即決）' },
     { value: '成約', label: '成約' },
     { value: '失注', label: '失注' },
   ]
   ```

2. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `finalResult`の選択肢を`getDropdownOptions('dealResult')`から取得

**影響範囲**:
- `dropdownSettings.ts`: `dealResult`の選択肢を更新
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

**注意事項**:
- 既存データで`検討中`が使用されている場合、マイグレーションが必要（後述）

---

#### 1.4 成約要因の追加

**現状**:
- 詳細画面でハードコードされている
- 選択肢: `価格`, `サービス内容`, `価格・サービス両方`, `その他`

**修正内容**:
1. **`dropdownSettings.ts`に新規項目を追加**:
   ```typescript
   contractReason: DropdownOption[]
   ```
   - `DEFAULT_SETTINGS`に初期値を追加:
     ```typescript
     contractReason: [
       { value: '価格', label: '価格' },
       { value: 'サービス内容', label: 'サービス内容' },
       { value: '価格・サービス両方', label: '価格・サービス両方' },
       { value: 'その他', label: 'その他' },
     ]
     ```

2. **設定メニュー（`settings/page.tsx`）に項目を追加**:
   - 商談管理セクションに追加:
     ```typescript
     { key: 'contractReason', label: '成約要因' }
     ```

3. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `contractReason`の選択肢を`getDropdownOptions('contractReason')`から取得

**影響範囲**:
- `dropdownSettings.ts`: 新規項目追加
- `settings/page.tsx`: 設定メニューに項目追加
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

---

#### 1.5 ISへのフィードバックの追加

**現状**:
- 詳細画面でハードコードされている
- 選択肢: `ニーズ全くなし`, `自己資金なし`, `日本語問題`, `興味本位（少しのニーズ）`, `開業時期1年以上先`, `その他`

**修正内容**:
1. **`dropdownSettings.ts`に新規項目を追加**:
   ```typescript
   feedbackToIS: DropdownOption[]
   ```
   - `DEFAULT_SETTINGS`に初期値を追加:
     ```typescript
     feedbackToIS: [
       { value: 'ニーズ全くなし', label: 'ニーズ全くなし' },
       { value: '自己資金なし', label: '自己資金なし' },
       { value: '日本語問題', label: '日本語問題' },
       { value: '興味本位（少しのニーズ）', label: '興味本位（少しのニーズ）' },
       { value: '開業時期1年以上先', label: '開業時期1年以上先' },
       { value: 'その他', label: 'その他' },
     ]
     ```

2. **設定メニュー（`settings/page.tsx`）に項目を追加**:
   - 商談管理セクションに追加:
     ```typescript
     { key: 'feedbackToIS', label: 'ISへのフィードバック' }
     ```

3. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `feedbackToIS`の選択肢を`getDropdownOptions('feedbackToIS')`から取得

**影響範囲**:
- `dropdownSettings.ts`: 新規項目追加
- `settings/page.tsx`: 設定メニューに項目追加
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

---

### 🟡 優先度2: 部分的不整合の修正

#### 2.1 BANT情報（B:予算, A:決裁権）の形式統一

**現状**:
- 設定メニュー: `B1.予算オーバー`, `B2.予算検討`, `B3.予算内`, `A1.決裁権限あり（一人で決定可）`, `A2.共同決済`, `A3.決裁権限なし`
- 詳細画面: `予算オーバー`, `予算内`, `確認中`, `検討中`, `不明`, `単独決裁者`, `共同決裁`, `決裁権限なし`, `不明`

**修正方針**: **詳細画面の選択肢を優先**（実際に使用されているため）

**修正内容**:
1. **`dropdownSettings.ts`に新規項目を追加**（`bantInfo`は複合項目のため、個別項目に分割）:
   ```typescript
   bantBudget: DropdownOption[]
   bantAuthority: DropdownOption[]
   ```
   - `DEFAULT_SETTINGS`に初期値を追加:
     ```typescript
     bantBudget: [
       { value: '予算オーバー', label: '予算オーバー' },
       { value: '予算内', label: '予算内' },
       { value: '確認中', label: '確認中' },
       { value: '検討中', label: '検討中' },
       { value: '不明', label: '不明' },
     ],
     bantAuthority: [
       { value: '単独決裁者', label: '単独決裁者' },
       { value: '共同決裁', label: '共同決裁' },
       { value: '決裁権限なし', label: '決裁権限なし' },
       { value: '不明', label: '不明' },
     ]
     ```

2. **設定メニュー（`settings/page.tsx`）に項目を追加**:
   - 商談管理セクションに追加:
     ```typescript
     { key: 'bantBudget', label: 'BANT情報（B:予算）' },
     { key: 'bantAuthority', label: 'BANT情報（A:決裁権）' },
     ```

3. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `bantBudget`の選択肢を`getDropdownOptions('bantBudget')`から取得
   - `bantAuthority`の選択肢を`getDropdownOptions('bantAuthority')`から取得

**影響範囲**:
- `dropdownSettings.ts`: 新規項目追加（`bantInfo`は後方互換性のため残す）
- `settings/page.tsx`: 設定メニューに項目追加
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

**注意事項**:
- `bantInfo`は既存データとの互換性のため残すが、新規開発では使用しない

---

#### 2.2 T:導入時期の選択肢統一

**現状**:
- 設定メニュー: `1カ月以内`, `3カ月以内`, `6カ月以内`, `1年以内`, `1年以上`, `未定`, `開業済（初年度）`, `開業２年目以降`
- 詳細画面: `即時`, `3日以内`, `1週間以内`, `1ヶ月以内`, `3ヶ月以内`, `3ヶ月以上`, `未定`

**修正方針**: **詳細画面の選択肢を優先**（実際に使用されているため）

**修正内容**:
1. **`dropdownSettings.ts`に新規項目を追加**（`openingPeriod`は別用途のため、新規項目を作成）:
   ```typescript
   bantTimeline: DropdownOption[]
   ```
   - `DEFAULT_SETTINGS`に初期値を追加:
     ```typescript
     bantTimeline: [
       { value: '即時', label: '即時' },
       { value: '3日以内', label: '3日以内' },
       { value: '1週間以内', label: '1週間以内' },
       { value: '1ヶ月以内', label: '1ヶ月以内' },
       { value: '3ヶ月以内', label: '3ヶ月以内' },
       { value: '3ヶ月以上', label: '3ヶ月以上' },
       { value: '未定', label: '未定' },
     ]
     ```

2. **設定メニュー（`settings/page.tsx`）に項目を追加**:
   - 商談管理セクションに追加:
     ```typescript
     { key: 'bantTimeline', label: 'BANT情報（T:導入時期）' },
     ```

3. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `bantTimeline`の選択肢を`getDropdownOptions('bantTimeline')`から取得

**影響範囲**:
- `dropdownSettings.ts`: 新規項目追加（`openingPeriod`は別用途のため残す）
- `settings/page.tsx`: 設定メニューに項目追加
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

**注意事項**:
- `openingPeriod`は別の用途（開業時期）で使用されているため、新規項目`bantTimeline`を作成

---

#### 2.3 競合・自己対応状況の選択肢統一

**現状**:
- 設定メニュー: `A1.他税理士（知り合い）`, `A2.他税理士（面談あり）`, `A3.他税理士（価格・サービス）`, `A4.税理士契約済`, `B1.自己対応（やってみる）`, `B2.商工会議所・青色申告会等`, `C1.他の競合・自己要因`
- 詳細画面: `なし`, `他税理士（知り合い）`, `他税理士（面談ありサービス）`, `他税理士（価格安い）`, `他税理士（サービスがいい）`（競合状況）、`なし`, `やってみる`, `商工会議所・青色申告会等サポート`, `自己対応検討`（自己対応状況）

**修正方針**: **詳細画面の選択肢を優先**（実際に使用されているため）

**修正内容**:
1. **`dropdownSettings.ts`に新規項目を追加**（`competitorStatus`は複合項目のため、個別項目に分割）:
   ```typescript
   competitorStatus: DropdownOption[]  // 競合状況
   selfHandlingStatus: DropdownOption[]  // 自己対応状況
   ```
   - `DEFAULT_SETTINGS`に初期値を追加:
     ```typescript
     competitorStatus: [
       { value: 'なし', label: 'なし' },
       { value: '他税理士（知り合い）', label: '他税理士（知り合い）' },
       { value: '他税理士（面談ありサービス）', label: '他税理士（面談ありサービス）' },
       { value: '他税理士（価格安い）', label: '他税理士（価格安い）' },
       { value: '他税理士（サービスがいい）', label: '他税理士（サービスがいい）' },
     ],
     selfHandlingStatus: [
       { value: 'なし', label: 'なし' },
       { value: 'やってみる', label: 'やってみる' },
       { value: '商工会議所・青色申告会等サポート', label: '商工会議所・青色申告会等サポート' },
       { value: '自己対応検討', label: '自己対応検討' },
     ]
     ```

2. **設定メニュー（`settings/page.tsx`）に項目を追加**:
   - 商談管理セクションに追加:
     ```typescript
     { key: 'competitorStatus', label: '競合状況' },
     { key: 'selfHandlingStatus', label: '自己対応状況' },
     ```

3. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `competitorStatus`の選択肢を`getDropdownOptions('competitorStatus')`から取得
   - `selfHandlingStatus`の選択肢を`getDropdownOptions('selfHandlingStatus')`から取得

**影響範囲**:
- `dropdownSettings.ts`: 新規項目追加（既存の`competitorStatus`は後方互換性のため残す）
- `settings/page.tsx`: 設定メニューに項目追加
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

**注意事項**:
- 既存の`competitorStatus`は後方互換性のため残すが、新規開発では使用しない

---

#### 2.4 商談フェーズの選択肢統一

**現状**:
- 設定メニュー: `初回商談`, `提案中`, `検討中`, `契約準備`
- 詳細画面: `検討中`, `契約準備`（2択のみ）

**修正方針**: **詳細画面の選択肢を優先**（実際に使用されているため）

**修正内容**:
1. **`dropdownSettings.ts`の`dealPhase`を更新**:
   ```typescript
   dealPhase: [
     { value: '検討中', label: '検討中' },
     { value: '契約準備', label: '契約準備' },
   ]
   ```

2. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `dealPhase1/2/3`の選択肢を`getDropdownOptions('dealPhase')`から取得

**影響範囲**:
- `dropdownSettings.ts`: `dealPhase`の選択肢を更新
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

**注意事項**:
- 既存データで`初回商談`, `提案中`が使用されている場合、マイグレーションが必要（後述）

---

#### 2.5 次回アクション内容の追加

**現状**:
- 設定メニュー: `再架電`, `メール送信`, `資料送付`
- 詳細画面: `回答確認`（追加）+ `getDropdownOptions('nextActionContent')`

**修正方針**: **詳細画面の選択肢を優先**（`回答確認`が実際に使用されているため）

**修正内容**:
1. **`dropdownSettings.ts`の`nextActionContent`を更新**:
   ```typescript
   nextActionContent: [
     { value: '回答確認', label: '回答確認' },
     { value: '再架電', label: '再架電' },
     { value: 'メール送信', label: 'メール送信' },
     { value: '資料送付', label: '資料送付' },
   ]
   ```

2. **`DealDetailPanel.tsx`のハードコードを削除**:
   - `回答確認`のハードコードを削除し、`getDropdownOptions('nextActionContent')`のみを使用

**影響範囲**:
- `dropdownSettings.ts`: `nextActionContent`の選択肢を更新
- `DealDetailPanel.tsx`: ハードコードを削除し、設定メニューから取得

---

## 修正ファイル一覧

### 修正が必要なファイル

1. **`frontend/src/lib/dropdownSettings.ts`**
   - 新規項目追加: `needTemperature`, `contractReason`, `feedbackToIS`, `bantBudget`, `bantAuthority`, `bantTimeline`, `competitorStatus`, `selfHandlingStatus`
   - 既存項目更新: `meetingStatus`, `dealResult`, `dealPhase`, `nextActionContent`

2. **`frontend/src/app/(auth)/settings/page.tsx`**
   - 設定メニューに新規項目を追加（架電管理・商談管理セクション）

3. **`frontend/src/components/calls/CallDetailPanel.tsx`**
   - ニーズ温度（IS判定）のハードコードを削除し、`getDropdownOptions('needTemperature')`を使用

4. **`frontend/src/components/deals/DealDetailPanel.tsx`**
   - 各種ハードコードを削除し、設定メニューから取得するように変更

---

## データマイグレーション（既存データ対応）

### マイグレーションが必要な項目

1. **商談実施状況**:
   - `商談キャンセル` → `キャンセル`
   - `商談実施` → `実施済`
   - `商談再設定` → `リスケ`
   - 新規追加: `実施前`（既存データで未設定の場合）

2. **商談最終結果**:
   - `検討中` → `失注`（または削除、要確認）

3. **商談フェーズ**:
   - `初回商談` → `検討中`
   - `提案中` → `検討中`

**マイグレーション方法**:
- SupabaseのSQLで一括更新（必要に応じて）
- または、表示時にマッピング（後方互換性のため）

---

## 実装順序

### Phase 1: 新規項目の追加（優先度1）
1. `dropdownSettings.ts`に新規項目を追加（`needTemperature`, `contractReason`, `feedbackToIS`）
2. 設定メニューに項目を追加
3. 詳細画面のハードコードを削除

### Phase 2: 既存項目の更新（優先度1）
1. `meetingStatus`, `dealResult`を更新
2. 詳細画面のハードコードを削除

### Phase 3: 部分的不整合の修正（優先度2）
1. BANT情報、導入時期、競合・自己対応状況、商談フェーズ、次回アクション内容を修正

### Phase 4: テスト・検証
1. 設定メニューで選択肢を変更した際に、詳細画面に反映されることを確認
2. 既存データの表示が正常であることを確認

---

## 注意事項

1. **後方互換性**: 既存の項目（`bantInfo`, `openingPeriod`, 旧`competitorStatus`）は後方互換性のため残す
2. **データ整合性**: 既存データで使用されている値が新しい選択肢に存在しない場合、マイグレーションが必要
3. **テスト**: 各修正後に、設定メニューで選択肢を変更した際に詳細画面に反映されることを確認

---

**作成者**: AI開発CTO  
**承認待ち**: 修正内容の確認後、実装を開始
