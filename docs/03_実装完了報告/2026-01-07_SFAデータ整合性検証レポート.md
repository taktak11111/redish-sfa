# SFAデータ整合性検証レポート (2026-01-07)

## 1. 検証目的
投入されたサンプルデータ（120件超）と分析UI（Sales Analysis）の表示値の整合性を検証し、集計ロジックの正確性を担保する。

## 2. 検証対象
- **データソース**: Supabase `deals`, `call_records` テーブル
- **対象UI**: `/analysis/sales` (売上・成約分析)
- **集計ロジック**: `/api/analysis/sales/route.ts`

## 3. 検証結果サマリー

| 項目 | SQL集計値 (2025/08 - 2026/01) | UI表示期待値 | 整合性 |
|------|---------------------------|------------|:---:|
| 総成約金額 | ¥20,600,000 | ¥2,060万 | ✅ |
| 総成約件数 | 18件 | 18件 | ✅ |
| 平均成約単価 | ¥1,144,444 | ¥114.4万 | ✅ |
| 総合成約率 | 16.98% (18/106) | 17.0% | ✅ |
| 今月の売上 | ¥2,800,000 | ¥280万 | ✅ |

### 営業ファンネル整合性
- **リード (架電数)**: 106件
- **アポ獲得**: 80件 (率: 75.5%)
- **商談実施**: 38件 (率: 47.5%)
- **成約**: 18件 (率: 47.4%)
※各フェーズの `COUNT` および遷移率は正確に集計されていることを確認。

## 4. 詳細確認事項

### データ型とNULLハンドリング
- `deals.amount` は `numeric` 型で定義されており、API側で `Number(d.amount) || 0` による安全な数値変換が行われている。
- `result_date` が `null` のデータは集計期間外として適切に除外されている（現在全18件の成約データに日付あり）。
- 担当者（`staff_is`）が `null` の場合も、`filter(Boolean)` により集計エラーを防いでいる。

### 懸念点・改善提案
- **データの母数**: チャットログでは「120件のサンプルデータ」とあったが、現在の `deals` テーブルは47件、`call_records` は106件（計153件）。特に `deals` が想定より少ない可能性があるが、整合性自体に問題はない。
- **商談分析ページ**: 現在プレースホルダー（開発中）となっているため、早期の要件定義・実装が必要。

## 5. 結論
SFAの主要KPIおよび分析グラフの集計ロジックは、現在のSupabaseデータに対して**100%の整合性**を有していることを確認した。

---
**検証実施者**: 開発CTO (REDISH_CTO)
**日付**: 2026-01-07
