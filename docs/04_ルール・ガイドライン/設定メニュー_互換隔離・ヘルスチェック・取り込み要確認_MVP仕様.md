---
title: "設定メニュー：互換隔離・ヘルスチェック・取り込み要確認（MVP仕様）"
created: 2026-01-15
updated: 2026-01-15
status: draft
tags:
  - REDISH_SFA
  - settings
  - dropdown_settings
  - import
  - QA
---

## 0. 前提

- 現時点では改修（コード変更）は行わない。まず仕様を確定する。
- 設定キーの正本（SSOT）は以下。
  - `docs/04_ルール・ガイドライン/設定キー台帳_DropdownSettings_SSOT.md`
- 要確認（needs_review）のDB設計は以下。
  - `docs/04_ルール・ガイドライン/データ品質_要確認テーブル設計_MVP.md`

---

## 1. ゴール（MVP）

### 1.1 互換隔離（Top5）

設定メニュー上で「旧互換（レガシー）キー/値」を誤って編集・選択しない状態にする。

### 1.2 ヘルスチェック

DB内の実値と「許容値（ドロップダウン設定）」を突合し、未登録値を可視化・回収できるようにする。

### 1.3 取り込み（Lenient）要確認フロー

未登録値は取り込み停止せず受け入れるが、必ず `needs_review（要確認）` に集約され、両画面（設定/取り込み結果）で追えるようにする。

---

## 2. 画面仕様（MVP）

### 2.1 設定画面（/settings）

対象タブ:
- 架電管理（call）
- 商談管理（dealManagement → DBカテゴリdeal）

追加UI（MVP）:
- **(A) 互換セクション（折りたたみ・警告表示）**
  - 「互換（旧データ表示用・原則編集禁止）」の見出しを追加
  - デフォルトは折りたたみ
  - 展開時に警告文を表示（例：過去データ表示のための互換枠。通常は編集しない）
- **(B) ヘルスチェック タブ（新規）**
  - 一覧表示：未登録値（キー別）
  - クリックで詳細：未登録値の一覧（値、件数、初出、関連レコード例）
  - アクション（MVPは「提案」まで。実行UIは次フェーズでも可）：
    - 許容値に追加（案）
    - 旧→新マッピング登録（案）
    - 取り込み側で変換（案）

表示ルール:
- 表示は常に `key（日本語名）`（SSOT辞書準拠）
- 互換枠は `（互換）` を併記

### 2.2 取り込み結果画面（/settings → シート連携 → データ）

追加UI（MVP）:
- **(A) 取り込み結果サマリー**
  - 取り込み件数
  - `needs_review（要確認）` 件数
  - 未登録値の件数（重複を除いたユニーク値数）
- **(B) 要確認一覧**
  - キー別にグルーピングし、未登録値を列挙
  - 例：`openingPeriod（開業時期）` に「1カ月以内」がXX件
- **(C) 設定へ誘導**
  - 「設定のヘルスチェックへ移動」導線（リンク/ボタン）

---

## 3. 互換隔離の対象（確定）

「Top5（確定）」は `設定キー台帳_DropdownSettings_SSOT.md` に準拠。

MVPでの扱い:
- 通常セクションからは除外（または末尾に移動）
- 互換セクションにまとめて表示
- 互換セクション内は閲覧のみ（MVP）。編集は次フェーズで管理者のみ検討

---

## 4. データ仕様（MVP）

### 4.1 検知対象（未登録値）

- 取り込み対象の各フィールド（例：開業時期など）から生成される「正規化後の値」が、該当キーの許容値に存在しない場合は未登録

### 4.2 正規化（最小）

- 前後空白を除去（trim）
- 空文字は無視（未登録として扱わず、別途「必須欠落」ルールに回す）

注:
- カ月/ヶ月、全角半角などの表記統一は次フェーズで「変換辞書」を持つ（MVPはtrimのみ）

### 4.3 要確認（needs_review）

MVPの要確認種別:
- 未登録値（unknown_option）

将来拡張:
- 必須欠落（required_missing）
- 形式不正（invalid_format）
- 変換失敗（mapping_failed）

---

## 5. ヘルスチェック（突合ロジック案）

入力:
- DBの対象テーブルから、対象フィールドの distinct 値集合（件数つき）
- 設定の許容値（dropdown_settings の options、または localStorage+DB統合後の設定）

出力:
- 未登録値の一覧（キー→未登録値→件数）

注意:
- 表示には必ず日本語名を併記（SSOT辞書）

---

## 6. 受け入れ条件（MVP）

### 6.1 設定画面

- 互換セクションがデフォルト折りたたみで表示される
- ヘルスチェックで「未登録値」がキー別に一覧できる
- 一覧・詳細で `key（日本語名）` 表記になっている

### 6.2 取り込み結果

- 取り込み後に `needs_review` 件数が表示される
- 要確認の内容（未登録値）がキー別に確認できる
- 設定画面のヘルスチェックへ誘導できる

---

## 7. 次の実装順（推奨）

1. 日本語辞書の参照（表示のみ）を設定画面/取り込み結果に導入
2. 互換セクション（折りたたみ）を設定画面に導入
3. 取り込み時に未登録値を抽出し、結果画面に表示（Lenient + needs_review）
4. 設定画面のヘルスチェック一覧を実装（一覧→詳細）
5. 変換辞書（カ月/ヶ月等）の追加（次フェーズ）

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-15 | 初版作成（MVP仕様） |

