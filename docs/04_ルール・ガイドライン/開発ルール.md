# REDISH SFA 開発ルール

**最終更新日**: 2025年12月25日  
**バージョン**: 1.1

---

## 1. 概要

本ドキュメントは、REDISH SFA Webアプリ開発における開発ルールを定義します。

### 1.1 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Next.js 14 + React 18 + TypeScript |
| UIライブラリ | Tailwind CSS |
| 状態管理 | TanStack Query (React Query) |
| フォーム | React Hook Form + Zod |
| 認証 | NextAuth.js + Google OAuth |
| データストア | Google Spreadsheet (既存) |
| API | Google Sheets API v4 |

---

## 2. プロジェクト構造

```
frontend/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/            # 認証が必要なルート
│   │   │   ├── dashboard/     # ダッシュボード
│   │   │   ├── leads/         # リード管理
│   │   │   ├── calls/         # 架電管理
│   │   │   ├── deals/         # 商談管理
│   │   │   ├── contracts/     # 成約・契約管理
│   │   │   └── analysis/      # 分析
│   │   ├── api/               # API Routes
│   │   │   ├── auth/          # 認証API
│   │   │   ├── leads/         # リードAPI
│   │   │   ├── calls/         # 架電API
│   │   │   ├── deals/         # 商談API
│   │   │   ├── contracts/     # 契約API
│   │   │   └── analysis/      # 分析API
│   │   ├── layout.tsx
│   │   └── page.tsx
│   ├── components/
│   │   ├── ui/                # 共通UIコンポーネント
│   │   ├── layout/            # レイアウトコンポーネント
│   │   ├── leads/             # リード関連コンポーネント
│   │   ├── calls/             # 架電関連コンポーネント
│   │   ├── deals/             # 商談関連コンポーネント
│   │   ├── contracts/         # 契約関連コンポーネント
│   │   └── analysis/           # 分析関連コンポーネント
│   ├── lib/
│   │   ├── sheets/            # Google Sheets API連携
│   │   ├── auth/              # 認証関連
│   │   └── utils/             # ユーティリティ
│   ├── hooks/                 # カスタムフック
│   ├── types/                 # 型定義
│   └── config/                # 設定
├── public/
└── package.json
```

---

## 3. コーディング規約

### 3.1 ファイル命名規則

| 種類 | 命名規則 | 例 |
|------|---------|-----|
| コンポーネント | PascalCase | `LeadList.tsx`, `DealCard.tsx` |
| ユーティリティ | camelCase | `sheetsApi.ts`, `dateUtils.ts` |
| 型定義 | camelCase | `lead.ts`, `deal.ts` |
| フック | camelCase + use | `useLeads.ts`, `useDeals.ts` |

### 3.2 コンポーネント構造

```typescript
// 1. インポート
import React from 'react';
import { ... } from '...';

// 2. 型定義
interface ComponentProps {
  // プロップス定義
}

// 3. コンポーネント
export const Component: React.FC<ComponentProps> = ({ ... }) => {
  // 4. フック
  const [state, setState] = useState(...);
  
  // 5. イベントハンドラ
  const handleClick = () => { ... };
  
  // 6. レンダリング
  return (
    // JSX
  );
};
```

### 3.3 型定義

- **any型の使用禁止**: やむを得ない場合は`unknown`を使用
- **すべての関数**: 引数と戻り値の型を定義
- **型定義の場所**: グローバル型は`src/types/`に配置

```typescript
// ✅ 良い例
interface Lead {
  id: string;
  source: LeadSource;
  status: LeadStatus;
  createdAt: Date;
}

// ❌ 悪い例
interface Lead {
  id: any;
  data: any;
}
```

### 3.4 Tailwind CSS

#### クラス名の順序
1. レイアウト（flex, grid, position）
2. サイズ（width, height, padding, margin）
3. タイポグラフィ（font, text）
4. カラー（bg, text, border）
5. その他（hover, transition, etc.）

```typescript
// ✅ 良い例
<div className="flex items-center gap-2 p-4 text-lg font-bold text-gray-900 hover:bg-gray-100">

// ❌ 悪い例
<div className="text-gray-900 flex p-4 hover:bg-gray-100 items-center">
```

#### カラーの使用
- カスタムカラー（`primary-600`等）を使用
- ハードコードされた色（`#xxxxxx`）の使用禁止

---

## 4. SFA固有のルール

### 4.1 ID体系

| ID種別 | 形式 | 例 |
|--------|------|-----|
| リードID(Meetsmore) | MT + 4桁 | MT0001 |
| リードID(TEMPOS) | TP + 4桁 | TP0001 |
| リードID(OMC) | OM + 4桁 | OM0001 |
| リードID(Amazon) | AM + 4桁 | AM0001 |
| リードID(Makuake) | MK + 4桁 | MK0001 |
| 商談ID | SA + 4桁 | SA0001 |
| 成約ID | CN + 4桁 | CN0001 |
| 顧客コード(飲食) | A + 6桁 | A000001 |
| 顧客コード(非飲食) | B + 6桁 | B000001 |

### 4.2 ステータス値

#### 架電ステータス
- `未架電`
- `架電中`
- `03.アポイント獲得済`
- `09.アポ獲得`

#### 商談結果
- `01.成約（契約締結）`
- `02.失注（リサイクル対象外）`
- `03.失注（リサイクル対象）`

#### 確度
- `A:80%`
- `B:50%`
- `C:20%`
- `D:10%`

#### 失注理由
- `A.自己対応`
- `B.競合決定`
- `C.予算`
- `D.時期`
- `E.ニーズ訴求不足`
- `F.(超)小規模店`
- `G.興味本位`
- `H.ノーショー（音信不通）`
- `I.弊社対応不可`
- `J.その他`

### 4.3 リードソース
- `TEMPOS`
- `OMC`
- `Meetsmore`
- `Amazon`
- `Makuake`
- `REDISH`

---

## 5. Google Sheets API連携

### 5.1 シート定義

```typescript
export const SHEETS = {
  LEAD_MEETSMORE: { 
    name: '11.Meetsmore', 
    idRow: 1, 
    headerRow: 5, 
    dataStartRow: 6 
  },
  LEAD_TEMPOS: { 
    name: '12.TEMPOS', 
    idRow: 1, 
    headerRow: 5, 
    dataStartRow: 6 
  },
  LEAD_OMC: { 
    name: '14.OMC', 
    idRow: 1, 
    headerRow: 5, 
    dataStartRow: 6 
  },
  LEAD_AMAZON: { 
    name: '15.Amazon', 
    idRow: 1, 
    headerRow: 5, 
    dataStartRow: 6 
  },
  LEAD_MAKUAKE: { 
    name: '3.Makuake', 
    idRow: 1, 
    headerRow: 5, 
    dataStartRow: 6 
  },
  CALL_MANAGEMENT: { 
    name: '架電管理表', 
    idRow: 1, 
    headerRow: 8, 
    dataStartRow: 9 
  },
  DEAL_MANAGEMENT: { 
    name: '商談管理表', 
    idRow: 1, 
    headerRow: 8, 
    dataStartRow: 9 
  },
  CONTRACT_MANAGEMENT: { 
    name: '成約管理表', 
    idRow: 1, 
    headerRow: 8, 
    dataStartRow: 9 
  },
  CONTRACT_FORM: { 
    name: '契約', 
    idRow: null, 
    headerRow: null, 
    dataStartRow: 4 
  },
};
```

### 5.2 カラムID体系

```typescript
export const COLUMN_IDS = {
  // 架電管理表 (K系)
  LEAD_ID: 'K01',
  LEAD_SOURCE: 'K02',
  LINK_DATE: 'K04',
  APPT_STATUS: 'K16',
  SETUP_DATE: 'K23',
  
  // 商談管理表 (S系)
  STAFF: 'S02',
  DETAIL_RANK: 'S04',
  RANK: 'S06',
  RESULT: 'S16',
  LOST_REASON: 'S18',
  DEAL_DATE: 'S22',
};
```

---

## 6. エラーハンドリング

### 6.1 API呼び出し

```typescript
// ✅ 良い例
export async function fetchLeads(): Promise<Lead[]> {
  try {
    const response = await sheetsApi.getValues('架電管理表', 'A9:AZ');
    return parseLeads(response);
  } catch (error) {
    console.error('[fetchLeads] リード取得エラー:', error);
    throw new Error('リードの取得に失敗しました。再度お試しください。');
  }
}
```

### 6.2 ユーザー向けエラーメッセージ

- 分かりやすく、次のアクションが明確
- 技術的な詳細は含めない

```typescript
// ✅ 良い例
'データの取得に失敗しました。ページを更新してください。'

// ❌ 悪い例
'Error: PERMISSION_DENIED'
```

---

## 7. Git運用

### 7.1 ブランチ戦略

- `main`: 本番環境用
- `develop`: 開発環境用
- `feature/`: 新機能開発
- `fix/`: バグ修正
- `hotfix/`: 緊急修正

### 7.2 コミットメッセージ

```
[種類] 簡潔な説明

- 詳細1
- 詳細2

関連: #123
```

**種類:**
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント
- `style`: コードスタイル
- `refactor`: リファクタリング
- `test`: テスト
- `chore`: その他

---

## 8. チェックリスト

### 実装前
- [ ] 要件定義書を確認した
- [ ] 既存のコンポーネントを確認（再利用可能か）
- [ ] 型定義を設計した
- [ ] 詳細画面（詳細パネル）を追加・改修する場合、Server-Driven UI設計書を確認した（`docs/02_詳細設計書/詳細設計書_Server-Driven UI_詳細画面の定義駆動.md`）

### 実装中
- [ ] 型定義を適切に設定
- [ ] エラーハンドリングを実装
- [ ] コメントを適切に追加

### 実装後
- [ ] any型を使用していない
- [ ] カスタムカラーを使用している
- [ ] エラーメッセージがユーザーフレンドリー
- [ ] 構造変更（ルール/設計/共通化）を行った場合、PROJECT_CONTROL.mdに記録した

---

## 9. 詳細画面（詳細パネル）を増やし続けるための設計：Server-Driven UI

詳細画面（商談/架電/契約など）は増殖しやすく、実装者ごとに揺れやすい。  
そのため、詳細画面は原則として「定義駆動（Server-Driven UI）」で設計・実装する。

- **正本（詳細設計）**: `docs/02_詳細設計書/詳細設計書_Server-Driven UI_詳細画面の定義駆動.md`
- **運用ルール**
  - 新しい詳細画面を作るときは、まず「セクション→フィールド」の定義を作る
  - フィールド追加/変更は「定義変更→動く」に寄せる（画面ごとに独自実装を増やさない）
  - 影響が大きい構造変更は `PROJECT_CONTROL.md` に記録する

---

## 10. 再発防止（氷山モデル）：繰り返し問題は層3（構造）に介入する

AIで「その場の修正」は速くなる一方、構造を変えないと同じ問題が繰り返される。  
繰り返し問題が出た場合は、出来事だけでなく「パターン→構造→前提」まで一段深く扱う。

- **発動条件（例）**
  - 型エラーが頻発している（同種が繰り返される）
  - 同じ詰まりで30分以上溶ける
  - 本番影響/データ破壊のリスクがある
- **ルール**
  - 原因の推測より先に「再現・分類・最小修正」を行う
  - 2回同じ罠を踏んだら、層3（構造）に介入する施策を必ず1つ入れる
  - 施策（ルール追加、共通化、チェックリスト追加など）を入れたら `PROJECT_CONTROL.md` に記録する

（型エラー対策の最低ラインとして、型チェックは `npx tsc --noEmit` を必須とする）

**更新履歴:**
- 2024-12-07: 初版作成
 - 2025-12-25: Server-Driven UI（詳細画面の定義駆動）と氷山モデル（再発防止）を追記





