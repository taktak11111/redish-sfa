# Cursor + Supabase + Vercel + GitHub 開発ガイド

**対象読者**: 非エンジニア・初学者  
**目的**: 次回のプロダクト開発時に、理解しながらスムーズに進められるようにする

---

## 0. 開発の全体像を理解する

### あなたが今回やったこと（全体フロー）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           開発から公開までの流れ                              │
└─────────────────────────────────────────────────────────────────────────────┘

【開発フェーズ】ローカルPC（あなたのパソコン）
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   ┌───────────────┐     ┌───────────────┐     ┌───────────────┐           │
│   │    Cursor     │     │   Frontend    │     │   API Routes  │           │
│   │  (エディタ)   │────▶│   (UI画面)    │────▶│  (データ処理)  │           │
│   │              │     │  React/Next.js │     │              │           │
│   └───────────────┘     └───────────────┘     └───────┬───────┘           │
│                                                       │                   │
│   npm run dev で開発サーバー起動                        │ HTTP通信          │
│   http://localhost:3000 でブラウザ確認                  ▼                   │
│                                               ┌───────────────┐           │
│                                               │   Supabase    │           │
│                                               │  (データベース) │◀──────────┤
│                                               │   クラウド上    │           │
│                                               └───────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ git push（コードをアップロード）
                                    ▼
【バージョン管理】GitHub（クラウド上のコード保管庫）
┌─────────────────────────────────────────────────────────────────────────────┐
│   リポジトリ: redish-sfa                                                    │
│   - frontend/（UIのコード）                                                  │
│   - supabase/（データベース設計）                                            │
│   - docs/（ドキュメント）                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 自動連携（pushを検知）
                                    ▼
【本番デプロイ】Vercel（ホスティングサービス）
┌─────────────────────────────────────────────────────────────────────────────┐
│   1. GitHubからコードを取得                                                  │
│   2. npm run build でビルド（本番用に変換）                                   │
│   3. 公開URLを発行: https://redish-sfa.vercel.app                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ ユーザーがアクセス
                                    ▼
【本番環境】インターネット上で公開
┌─────────────────────────────────────────────────────────────────────────────┐
│   ユーザー ───▶ Vercel（UI配信）───▶ Supabase（データ取得）                  │
│              https://xxx.vercel.app    https://xxx.supabase.co              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 各ツール・サービスの役割

| ツール/サービス | カテゴリ | 役割 | たとえ話 |
|---------------|---------|------|---------|
| **Cursor** | エディタ（ローカル） | コードを書く・AIが補助 | 料理人が使う「まな板と包丁」|
| **Next.js** | フレームワーク | UIとAPIを統合して動かす | 「調理場」全体の仕組み |
| **npm run dev** | 開発サーバー | ローカルで動作確認 | 試食コーナー（社内向け）|
| **Supabase** | データベース（クラウド） | データを保存・管理 | 食材を保管する「冷蔵庫」|
| **GitHub** | コード管理（クラウド） | コードを保存・履歴管理 | 「レシピ帳」を保管する金庫 |
| **Vercel** | ホスティング（クラウド） | アプリを世界に公開 | 一般公開の「レストラン」|

---

### アプリの構造（Frontend と API の関係）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Next.js アプリケーション                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【Frontend（フロントエンド）】                                   │
│  ユーザーが見る画面・操作するUI                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  src/app/(auth)/calls/page.tsx    → 架電管理画面          │   │
│  │  src/app/(auth)/deals/page.tsx    → 商談管理画面          │   │
│  │  src/app/(auth)/contracts/page.tsx → 成約管理画面         │   │
│  │  src/components/                   → 再利用可能な部品      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              │ fetch('/api/calls') などで通信   │
│                              ▼                                  │
│  【API Routes（APIルート）】                                      │
│  データの取得・保存を担当                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  src/app/api/calls/route.ts    → 架電データの処理         │   │
│  │  src/app/api/deals/route.ts    → 商談データの処理         │   │
│  │  src/app/api/call-history/route.ts → 履歴データの処理     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              │ Supabase Client で通信           │
│                              ▼                                  │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Supabase（データベース）                       │
├─────────────────────────────────────────────────────────────────┤
│  call_records テーブル  → 架電記録                               │
│  deals テーブル         → 商談記録                               │
│  call_history テーブル  → 架電履歴                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 1. 全体像：4つのサービスの役割

```
┌─────────────────────────────────────────────────────────────────┐
│                    あなたのWebアプリケーション                    │
└─────────────────────────────────────────────────────────────────┘
                              │
    ┌───────────┬─────────────┼─────────────┬───────────┐
    ▼           ▼             ▼             ▼           ▼
┌────────┐ ┌────────┐  ┌───────────┐  ┌────────┐ ┌──────────┐
│ Cursor │ │ GitHub │  │  Vercel   │  │Supabase│ │ブラウザ  │
│(開発)  │ │(保管)  │──▶│ (公開)    │◀─│ (DB)   │ │(利用)    │
└────────┘ └────────┘  └───────────┘  └────────┘ └──────────┘
  ローカル    クラウド      クラウド       クラウド     ユーザー
```

---

## 2. Cursorでの開発フロー

### Cursorとは？

**Cursor**は、AIが組み込まれたコードエディタです。  
Visual Studio Codeをベースに、AIアシスタント機能が追加されています。

| 機能 | 説明 |
|-----|------|
| **コード編集** | ファイルを開いて編集 |
| **AI補助** | 質問したり、コード生成を依頼 |
| **ターミナル** | コマンドを実行 |
| **Git連携** | バージョン管理 |

### 開発の基本サイクル

```
┌─────────────────────────────────────────────────────────────┐
│                   Cursorでの開発サイクル                      │
└─────────────────────────────────────────────────────────────┘

1️⃣ プロジェクトを開く
   Cursor で frontend フォルダを開く

2️⃣ 開発サーバーを起動
   ターミナルで: npm run dev
   → http://localhost:3000 でブラウザ確認

3️⃣ コードを編集
   - ファイルを開いて修正
   - AIに質問・依頼
   - 保存すると自動で画面に反映（ホットリロード）

4️⃣ 動作確認
   ブラウザで http://localhost:3000 を確認
   → 問題なければ次へ、問題あれば 3️⃣ に戻る

5️⃣ 型チェック
   ターミナルで: npx tsc --noEmit
   → エラーがあれば修正

6️⃣ コミット＆プッシュ
   ターミナルで:
   git add .
   git commit -m "変更内容の説明"
   git push origin main

7️⃣ Vercelが自動デプロイ
   GitHubへのpushを検知して自動でビルド・公開
   → 公開URLで確認
```

---

## 3. 準備：必要なアカウントとツール

### 必要なアカウント（すべて無料プランあり）

1. **GitHub**: https://github.com
2. **Vercel**: https://vercel.com
3. **Supabase**: https://supabase.com

### 必要なツール（ローカルPC）

1. **Cursor**: https://cursor.sh
2. **Node.js**: https://nodejs.org (LTS推奨)
3. **Git**: https://git-scm.com

---

## 4. セットアップ手順

### STEP 1: Supabaseプロジェクトの作成

1. Supabaseで「New Project」を作成（Region: Tokyo推奨）
2. **Project Settings** → **API** から以下をメモ：
   - Project URL
   - anon key (public)
   - service_role key (secret) ※Vercel環境変数に必要

### STEP 2: Cursorでプロジェクトを作成

1. `npx create-next-app@latest` でプロジェクト作成
2. `@supabase/supabase-js` をインストール
3. `.env.local` ファイルを作成し、環境変数を設定

### STEP 3: GitHubリポジトリの作成

1. GitHubで新しいリポジトリを作成
2. ローカルのコードをpush

```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin [リポジトリURL]
git push -u origin main
```

### STEP 4: Vercelでデプロイ

1. VercelでGitHubリポジトリをインポート
2. **Framework Preset**: Next.js
3. **Environment Variables** (環境変数) を設定：
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `NEXTAUTH_URL` (本番URL: `https://redish-sfa.vercel.app`)
   - `NEXTAUTH_SECRET`
   - `GOOGLE_CLIENT_ID`
   - `GOOGLE_CLIENT_SECRET`
4. Deployをクリック

---

## 5. データの流れを理解する

### ユーザーがデータを取得するまで

```
1. ユーザーがブラウザで https://xxx.vercel.app/calls にアクセス

2. Vercel が calls/page.tsx を配信

3. ブラウザが JavaScript を実行
   → fetch('/api/calls') を呼び出し

4. Vercel の API Route (api/calls/route.ts) が実行される

5. API Route が Supabase に接続
   → SELECT * FROM call_records

6. Supabase がデータを返す

7. API Route がデータを整形して返す

8. ブラウザが受け取ったデータを画面に表示
```

---

## 6. よくあるトラブルと解決方法

### トラブル1: ビルドエラー（型エラー）

**症状**: Vercelで「Type error」  
**解決方法**: push前に必ず `npx tsc --noEmit` を実行し、エラーを解消する。

### トラブル2: 「Invalid supabaseUrl」エラー

**症状**: ビルド時にエラーが出る  
**解決方法**: Supabaseクライアントの初期化を遅延させる（関数内で `createClient` する）。

### トラブル3: 環境変数が読み込まれない

**症状**: API呼び出しが失敗する  
**解決方法**:
- Vercelの環境変数設定を確認
- ローカルなら `.env.local` を確認
- `NEXT_PUBLIC_` 以外の変数はクライアント側（ブラウザ）では使えない

### トラブル4: Google認証エラー (redirect_uri_mismatch)

**症状**: Googleログイン画面でエラー  
**解決方法**:
- Google Cloud Console の「承認済みのリダイレクトURI」を確認
- 末尾まで正確に入力されているか (`/api/auth/callback/google`)

---

## 付録A: REDISH SFA データベース設計

### A-1. ER図（Entity Relationship Diagram）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           REDISH SFA ER図                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────┐
│         users           │
├─────────────────────────┤
│ PK id (UUID)            │──┐
│    email (TEXT)         │  │
│    full_name (TEXT)     │  │      ※現在はauth.usersと連携
│    role (TEXT)          │  │      （認証機能実装時に使用）
│    department (TEXT)    │  │
│    created_at           │  │
│    updated_at           │  │
└─────────────────────────┘  │
                             │
                             │
┌─────────────────────────┐  │
│     call_records        │  │      1対多
│   （架電管理テーブル）    │◀─┴───────────────────────────┐
├─────────────────────────┤                              │
│ PK id (UUID)            │──────────────────────────┐   │
│ UK lead_id (TEXT)       │◀──────────────────┐      │   │
│    lead_source          │                   │      │   │
│    company_name         │                   │      │   │
│    contact_name         │                   │      │   │
│    phone                │                   │      │   │
│    status               │                   │      │   │
│    staff_is             │                   │      │   │
│    call_count           │                   │      │   │
│    last_called_date     │                   │      │   │
│    ...（計40+カラム）    │                   │      │   │
│    created_at           │                   │      │   │
│    updated_at           │                   │      │   │
└─────────────────────────┘                   │      │   │
         │                                    │      │   │
         │ 1対多                              │      │   │
         ▼                                    │      │   │
┌─────────────────────────┐                   │      │   │
│     call_history        │                   │      │   │
│   （架電履歴テーブル）    │                   │      │   │
├─────────────────────────┤                   │      │   │
│ PK id (UUID)            │                   │      │   │
│ FK call_record_id (UUID)│───────────────────┘      │   │
│    call_date            │                          │   │
│    call_time            │                          │   │
│    staff_is             │                          │   │
│    status               │                          │   │
│    result               │                          │   │
│    duration             │                          │   │
│    memo                 │                          │   │
│    created_at           │                          │   │
└─────────────────────────┘                          │   │
                                                     │   │
                                                     │   │
┌─────────────────────────┐                          │   │
│         deals           │                          │   │
│    （商談管理テーブル）   │                          │   │
├─────────────────────────┤                          │   │
│ PK id (UUID)            │                          │   │
│ UK deal_id (TEXT)       │                          │   │
│ FK lead_id (TEXT)       │──────────────────────────┘   │
│    company_name         │                              │
│    contact_name         │                              │
│    service              │                              │
│    category             │                              │
│    rank                 │                              │
│    result               │                              │
│    deal_phase           │                              │
│    ...（計50+カラム）    │                              │
│    created_at           │                              │
│    updated_at           │                              │
└─────────────────────────┘                              │
                                                         │
                                                         │
┌─────────────────────────┐                              │
│   dropdown_settings     │                              │
│  （ドロップダウン設定）   │                              │
├─────────────────────────┤                              │
│ PK id (UUID)            │                              │
│    category (TEXT)      │                              │
│    key (TEXT)           │                              │
│    options (JSONB)      │                              │
│    created_at           │                              │
│    updated_at           │                              │
└─────────────────────────┘                              │

【凡例】
  PK = Primary Key（主キー）
  FK = Foreign Key（外部キー）
  UK = Unique Key（ユニークキー）
  ──▶ = 参照関係（多対1）
```

---

## 付録B: Frontend改修 → Backend/DB改修のワークフロー

### B-1. 全体の流れ

Cursorでフロントエンドを改修すると、それに応じてバックエンド（API）やデータベース（Supabase）も変更が必要になることがあります。

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Frontend改修 → Backend/DB改修フロー                          │
└─────────────────────────────────────────────────────────────────────────────────┘

【STEP 1】フロントエンド改修
    │
    │  新しい画面・機能を追加
    │  例: 「担当者別の成績表示」機能を追加したい
    │
    ▼
【STEP 2】必要なデータを特定
    │
    │  「この機能に必要なデータは何か？」を考える
    │  例: 担当者ごとの架電数、アポ率、成約率が必要
    │
    ▼
【STEP 3】DB変更が必要か判断
    │
    │  ┌─────────────────────────────────────────────┐
    │  │ 判断基準                                    │
    │  │ ・既存カラムで対応可能？ → APIのみ修正      │
    │  │ ・新しいカラム/テーブルが必要？ → DB変更    │
    │  └─────────────────────────────────────────────┘
    │
    ▼
【STEP 4】DB変更（必要な場合）
    │
    │  Supabase SQL Editor または Supabase MCP で変更
    │  例: ALTER TABLE call_records ADD COLUMN performance_score INTEGER;
    │
    ▼
【STEP 5】API改修
    │
    │  src/app/api/xxx/route.ts を修正
    │  ・新しいカラムの読み書き
    │  ・新しいエンドポイントの追加
    │
    ▼
【STEP 6】フロントエンド連携
    │
    │  APIを呼び出すコードを追加
    │  型定義（src/types/sfa.ts）を更新
    │
    ▼
【STEP 7】テスト & デプロイ
    │
    │  ローカルで動作確認 → git push → Vercel自動デプロイ
    │
    ▼
【完了】本番環境で機能が動作
```

---

## 付録C: Google認証（OAuth）の設定手順

### C-1. 全体の流れ

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Google認証 設定フロー                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

【STEP 1】Google Cloud Console でプロジェクト作成
    │
    ▼
【STEP 2】OAuth同意画面の設定
    │
    ▼
【STEP 3】OAuth クライアントIDの作成
    │
    ▼
【STEP 4】環境変数の設定（ローカル & Vercel）
    │
    ▼
【STEP 5】動作確認
```

### C-2. Google Cloud Console での設定（重要）

1. **OAuth 2.0 クライアントID** を作成（種類: ウェブアプリケーション）
2. **承認済みのJavaScript生成元** に以下を追加：
   ```
   http://localhost:3000
   https://redish-sfa.vercel.app
   ```
   ※ `https://redish-sfa.vercel.app` はVercelのプロダクションドメイン

3. **承認済みのリダイレクトURI** に以下を追加（**末尾まで正確に！**）：
   ```
   http://localhost:3000/api/auth/callback/google
   https://redish-sfa.vercel.app/api/auth/callback/google
   ```

### C-3. 環境変数の設定

| 変数名 | Vercel設定値 | ローカル(.env.local) | 備考 |
|--------|------------|-------------------|------|
| `GOOGLE_CLIENT_ID` | (Google Cloudから取得) | 同じ | |
| `GOOGLE_CLIENT_SECRET` | (Google Cloudから取得) | 同じ | **スペースが入らないように注意！** |
| `NEXTAUTH_URL` | `https://redish-sfa.vercel.app` | `http://localhost:3000` | 本番とローカルで異なる |
| `NEXTAUTH_SECRET` | (ランダムな32文字以上の文字列) | 同じ | `openssl rand -base64 32` 等で生成 |
| `ALLOWED_EMAIL_DOMAINS` | `redish.jp` | `redish.jp` | ログイン許可ドメイン |

---

## 付録D: 【保存版】非エンジニアのための技術概念ガイド

環境構築でつまずきやすい「環境変数」や「認証」などの概念を、身近な例えで解説します。

### D-1. 環境変数（.env）の謎

#### 🤔 なぜコードに直接書かないの？
例えば、あなたの家の鍵を「誰でも見れる掲示板（GitHub）」に貼り付ける人はいませんよね？
コード（プログラム）はGitHubで公開される可能性があるため、**「鍵（パスワード）」や「秘密の設定」はコードの中に書いてはいけない**という鉄則があります。

#### 💡 たとえ話：魔法の料理レシピ
あなたは世界中に公開する「カレーのレシピ（コード）」を書いています。

*   **ダメな例**: 「隠し味に、私の家の冷蔵庫にある『秘伝ソース（パスワード）』を入れてください」と書く。
    *   → 読んだ人はあなたの家に侵入しようとします（危険！）。
*   **良い例（環境変数）**: 「隠し味に『**環境変数: SECRET_SOURCE**』を入れてください」と書く。
    *   → 実際に入れるソースは、料理する人（環境）ごとの「メモ帳（.envファイル）」で指定します。
    *   **あなたの家（ローカル）**: メモ帳に「おばあちゃんのソース」と書く。
    *   **レストラン（本番環境/Vercel）**: メモ帳に「高級業務用ソース」と書く。

#### 🔑 .env.local と Vercel環境変数の違い
| ファイル/場所 | 役割 | たとえ話 |
|-------------|------|---------|
| **.env.local** | あなたのPC専用の設定ファイル。GitHubにはアップロードしない（.gitignoreで除外）。 | **「自宅の冷蔵庫のメモ」**。家族しか見れません。 |
| **Vercel環境変数** | 本番サーバー用の設定画面。Web上の管理画面で入力する。 | **「レストラン厨房の金庫」**。店長（あなた）しか開けられません。 |

---

### D-2. Google認証（OAuth）の紙芝居

#### 🤔 なぜGoogleログインを使うの？
ユーザーに新しいパスワードを覚えさせるのは大変ですし、パスワードを安全に管理するのはもっと大変です（流出したら大事故！）。
Google認証を使えば、**「パスワードの管理をGoogleにお任せ」**できます。これを **OAuth（オーオース）** と呼びます。

#### 💡 たとえ話：高級ホテルの入館証
あなたは「REDISH SFA」という会員制ホテルのオーナーです。

1.  **お客さん（ユーザー）**: 「入りたいです！」
2.  **あなた（アプリ）**: 「身分証を見せてください。あ、Google発行のパスポートでもいいですよ」
3.  **お客さん**: Googleの窓口（Googleログイン画面）に行く。
4.  **Google**: 「あなたは本当に〇〇さんですか？（パスワード入力）」→「OK、本人確認できました」
5.  **Google**: お客さんに**「紹介状（トークン）」**を渡す。「これを持ってREDISHホテルに戻りなさい」
6.  **お客さん**: あなたに紹介状を渡す。
7.  **あなた**: 「Googleさんの紹介状なら信用します。どうぞ！」

#### 🚧 ここでハマりやすいポイント
*   **クライアントID/シークレット**: ホテル（あなた）がGoogleと提携するために必要な「契約者番号」と「印鑑」です。これが間違っているとGoogleは相手にしてくれません。
*   **リダイレクトURI**: Googleが紹介状を持ったお客さんを**「どこに送り返せばいいか」**の住所です。
    *   これが「ホテルの裏口」になっているのに、Googleに「正面玄関」と伝えていたら、お客さんは迷子になります（`redirect_uri_mismatch` エラー）。
    *   **PCで開発中**は「自宅（localhost）」に戻ってきてほしい。
    *   **本番公開後**は「お店（vercel.app）」に戻ってきてほしい。
    *   だから2つの住所を登録する必要があるのです。

---

### D-3. ビルドとデプロイの正体

#### 🤔 デプロイって何？
「作ったコードをGitHubに上げる」だけでは、世界中の人はアクセスできません。
**Vercel** のようなサーバーに置いて、誰でも見れる状態にすることを **デプロイ（配備・展開）** と言います。

#### 💡 たとえ話：新商品の発売
1.  **コーディング（開発）**: 工場で試作品を作っている段階。まだ設計図（コード）の状態。
2.  **ビルド（Build）**: 設計図を元に、実際に販売できる「製品」に組み立てる工程。
    *   人間が読みやすいコード（TypeScript）を、機械が高速に動かせるコード（JavaScript）に変換・圧縮します。
    *   ここで「設計図ミス（型エラー）」があると、製品化できずにストップします。
3.  **デプロイ（Deploy）**: 完成した製品をお店（サーバー）の棚に並べること。これでやっとお客さんが手に取れます。

#### 🔄 開発の流れ再確認
1.  **Cursorで試作**（ローカル開発）
2.  **GitHubに設計図を保管**（Push）
3.  **Vercelが設計図を受け取る**（自動連携）
4.  **Vercelが製品を組み立てる**（ビルド）
5.  **Vercelがお店に並べる**（デプロイ完了）

---

**作成日**: 2025年12月7日  
**更新日**: 2025年12月7日  
**プロジェクト**: REDISH SFA  
**作成者**: Cursor AI Assistant





