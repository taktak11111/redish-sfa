# 要件定義書: 売上・成約分析機能 (Sales & Revenue Analysis)

## 1. はじめに
営業活動の最終成果である「売上」と、そこに至る「成約率」を多角的に分析し、経営判断（投資判断・リソース配分）および営業戦略の精緻化を支援する。

## 2. ユーザーストーリー
- **経営者として**: 
  - 月次の売上推移と前月比成長率を確認し、事業のスケール状況を把握したい。
  - サービス別・担当者別の収益性を比較し、どの領域に投資すべきか判断したい。
- **営業マネージャーとして**: 
  - 成約に至るまでの歩留まり（リード→商談→成約）を可視化し、ボトルネック工程を特定したい。
  - 担当者別の「成約単価」と「成約率」の相関を確認し、個別の教育方針を立てたい。

## 3. 機能要件

### 3.1 経営管理KPIサマリー (Top Metrics)
- **目的**: ひと目で経営状況の「異常」と「好調」を察知する。
- **表示項目**:
  - **総成約金額**: 期間内の有効成約金額の合計（円）。
  - **前月比成長率 (MoM)**: 前月同時期との売上比較（%）。
  - **平均成約単価**: 総売上 ÷ 成約件数（円）。
  - **総合成約率**: リード（架電）数に対する成約数の割合（%）。

### 3.2 売上・件数推移（二軸チャート）
- **目的**: 売上の「質」と「量」の変化を捉える。
- **仕様**:
  - **二軸グラフ**: 売上金額（棒グラフ）と成約件数（折れ線グラフ）を月次/週次/日次で表示。
  - **ライブラリ**: Recharts を使用し、インタラクティブなツールチップを提供。

### 3.3 営業プロセス・歩留まり（漏斗分析）
- **目的**: どのフェーズで顧客が離脱しているかを特定する。
- **仕様**:
  - **ファンネルチャート**: リード獲得 -> アポ獲得 -> 商談実施 -> 成約 の各転換率を表示。
  - **離脱分析**: 前ステップからの減少幅を可視化。

### 3.4 担当者別・収益性マトリクス
- **目的**: 誰が「高く売っているか」と「効率よく売っているか」を分析する。
- **仕様**:
  - **比較テーブル**: 担当者ごとの合計売上、成約率、平均単価、商談化率。
  - **ランキング**: 売上上位者のハイライト表示。

### 3.5 サービス/カテゴリ別構成比
- **目的**: プロダクトミックスの健全性を確認する。
- **仕様**:
  - **パイチャート**: 商品・サービス別の売上構成比。

## 4. 非機能要件
- **データ鮮度**: Supabaseからのリアルタイム取得。
- **パフォーマンス**: 複雑な集計（SQLの聚合関数を利用）をサーバーサイド（API Route）で行い、フロントエンドの負荷を軽減する。
- **権限管理**: 役職に応じたデータ参照範囲の制御（RLS）。

## 5. データの流れ（詳細）
1. **API**: `/api/analysis/sales` エンドポイントを新設。
2. **集計ロジック**:
   - `deals` テーブル (`result = '01.成約（契約締結）'`) の `amount` を SUM。
   - `calls` と `deals` を結合し、リレーションに基づいた転換率を算出。
3. **フロントエンド**: TanStack Query で集計済みデータを取得。

## 7. 現状分析とギャップ (Gap Analysis)
- **DBスキーマ**: 現在 `deals` テーブルに `amount`（成約金額）カラムが存在しない。
  - **対策**: マイグレーションにて `amount` カラムを追加する。
- **データ不整合**: 既存の `/analysis/sales` ページが「インサイド分析」として動作しており、要件が混在している。
  - **対策**: 既存の「インサイド分析」要素は `call-analysis` または `inside-sales-analysis` として整理し、本ページは「売上・成果分析」に特化させる。

---

## 8. 技術メモ
- **URL**: `/analysis/sales`
- **使用ライブラリ**: `recharts`, `date-fns`
- **対象テーブル**: `deals`, `call_records`, `users`
- **備考**: 現在の `/analysis/sales` 実装（インサイド分析）を、この要件に基づき全面刷新する。
